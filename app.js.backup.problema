import express from "express";
import cors from "cors";
import dotenv from "dotenv";

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors({
  origin: [
    "http://localhost:5173",
    "http://localhost:5174",
    "http://212.85.10.205:3000",
    "https://jotasolucoes.com.br",
    "https://bancojota.com.br"
  ],
  credentials: true,
  methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"],
  allowedHeaders: ["Content-Type", "Authorization", "X-Requested-With", "Accept", "Origin"]
}));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

app.get("/api/health", (req, res) => {
  res.json({
    status: "OK",
    message: "Backend FUNCIONAL!",
    server: "212.85.10.205:3000",
    timestamp: new Date().toISOString()
  });
});

app.post("/api/auth/login", (req, res) => {
  const { username, password } = req.body;
  if (username === "admin" && password === "admin123") {
    res.json({
      success: true,
      message: "Login realizado com sucesso",
      token: "token-" + Date.now(),
      user: { id: 1, username: "admin", role: "admin" }
    });
  } else {
    res.status(401).json({ success: false, message: "Credenciais inv√°lidas" });
  }
});

app.get("/api/auth/verify", (req, res) => {
  res.json({
    success: true,
    user: { id: 1, username: "admin", role: "admin" }
  });
});

app.post("/api/auth/logout", (req, res) => {
  res.json({ success: true, message: "Logout realizado" });
});

app.get("/api/content/landing", (req, res) => {
  const landingPages = [
    {
      id: "jota-solucoes",
      slug: "jota-solucoes",
      title: "Jota Solu√ß√µes",
      description: "Landing page para BPO Financeiro",
      status: "published",
      createdAt: "2025-07-14T17:40:00.000Z",
      updatedAt: new Date().toISOString(),
      url: "https://jotasolucoes.com.br"
    },
    {
      id: "banco-jota",
      slug: "banco-jota",
      title: "Banco Jota",
      description: "Landing page do Banco Jota",
      status: "published",
      createdAt: "2025-07-10T15:30:00.000Z",
      updatedAt: new Date().toISOString(),
      url: "https://bancojota.com.br"
    }
  ];

  res.json({
    success: true,
    data: landingPages,
    total: landingPages.length,
    message: "Landing pages listadas com sucesso"
  });
});

// ‚úÖ NOVO ENDPOINT ESPEC√çFICO: Carregar conte√∫do detalhado de uma landing page para edi√ß√£o
app.get("/api/content/landing/:slug", (req, res) => {
  try {
    const { slug } = req.params;
    console.log("üìã Carregando conte√∫do detalhado de:", slug);
    
    // Dados espec√≠ficos da Jota Solu√ß√µes
    if (slug === "jota-solucoes") {
      const jotaSolucoesContent = {
        id: "jota-solucoes",
        slug: "jota-solucoes",
        title: "Jota Solu√ß√µes",
        description: "Landing page para BPO Financeiro - Diagn√≥stico financeiro gratuito",
        status: "published",
        createdAt: "2025-07-14T17:40:00.000Z",
        updatedAt: new Date().toISOString(),
        publishedAt: "2025-07-14T18:00:00.000Z",
        url: "https://jotasolucoes.com.br",
        
        // ‚úÖ BLOCOS EDIT√ÅVEIS PARA O PAINEL ADMIN
        blocks: [
          {
            id: "header",
            type: "header",
            title: "Cabe√ßalho",
            position: 1,
            visible: true,
            editable: true,
            content: {
              logo: {
                src: "/uploads/images/jota-solucoes-logo.png",
                alt: "Jota Solu√ß√µes",
                width: 150,
                height: 60
              },
              navigation: [
                { label: "In√≠cio", url: "#inicio", active: true },
                { label: "Servi√ßos", url: "#servicos", active: true },
                { label: "Sobre", url: "#sobre", active: true },
                { label: "Contato", url: "#contato", active: true }
              ],
              ctaButton: {
                text: "Diagn√≥stico Gratuito",
                url: "#formulario",
                style: "primary",
                visible: true
              },
              styles: {
                backgroundColor: "#ffffff",
                textColor: "#333333",
                logoPosition: "left"
              }
            }
          },
          {
            id: "hero",
            type: "hero", 
            title: "Se√ß√£o Hero",
            position: 2,
            visible: true,
            editable: true,
            content: {
              headline: "Descubra como transformar a sa√∫de financeira da sua empresa!",
              subheadline: "Receba um diagn√≥stico financeiro gratuito e tenha uma reuni√£o estrat√©gica com o CEO da Jota Solu√ß√µes.",
              description: "Nossa metodologia j√° ajudou mais de 450 mil empresas a organizar suas finan√ßas e acelerar o crescimento.",
              backgroundImage: {
                src: "/uploads/images/hero-bg-jota.jpg",
                alt: "Background Jota Solu√ß√µes",
                overlay: 0.6
              },
              ctaButton: {
                text: "Quero meu diagn√≥stico gratuito",
                url: "#formulario",
                style: "primary",
                size: "large"
              },
              secondaryButton: {
                text: "Conhecer servi√ßos",
                url: "#servicos",
                style: "outline",
                visible: true
              },
              features: [
                {
                  icon: "check-circle",
                  text: "Diagn√≥stico financeiro completo"
                },
                {
                  icon: "check-circle", 
                  text: "Reuni√£o estrat√©gica personalizada"
                },
                {
                  icon: "check-circle",
                  text: "An√°lise de 450 mil empresas"
                },
                {
                  icon: "check-circle",
                  text: "Resultados comprovados"
                }
              ],
              styles: {
                textAlign: "center",
                headlineColor: "#ffffff",
                subheadlineColor: "#f8f9fa",
                buttonColor: "#0066cc"
              }
            }
          },
          {
            id: "dores",
            type: "pain-points",
            title: "Dores e Problemas",
            position: 3,
            visible: true,
            editable: true,
            content: {
              headline: "Sua empresa enfrenta esses desafios financeiros?",
              subheadline: "Sabemos que gerenciar as finan√ßas de uma empresa pode ser complexo e desafiador.",
              problems: [
                {
                  icon: "alert-triangle",
                  title: "Fluxo de caixa descontrolado",
                  description: "Dificuldade para acompanhar entradas e sa√≠das em tempo real"
                },
                {
                  icon: "eye-off",
                  title: "Falta de visibilidade financeira",
                  description: "N√£o saber exatamente a situa√ß√£o financeira da empresa"
                },
                {
                  icon: "clock",
                  title: "Processos manuais demorados",
                  description: "Perda de tempo com planilhas e controles manuais"
                },
                {
                  icon: "bar-chart",
                  title: "Decis√µes sem dados precisos",
                  description: "Tomar decis√µes importantes sem informa√ß√µes confi√°veis"
                }
              ],
              styles: {
                backgroundColor: "#f8f9fa",
                textColor: "#333333",
                iconColor: "#dc3545"
              }
            }
          },
          {
            id: "solucoes",
            type: "solutions",
            title: "Nossas Solu√ß√µes",
            position: 4,
            visible: true,
            editable: true,
            content: {
              headline: "Como a Jota Solu√ß√µes resolve seus problemas financeiros",
              subheadline: "Oferecemos solu√ß√µes completas para transformar a gest√£o financeira da sua empresa.",
              solutions: [
                {
                  icon: "trending-up",
                  title: "BPO Financeiro Completo",
                  description: "Terceiriza√ß√£o completa do setor financeiro com processos otimizados",
                  features: [
                    "Controle de fluxo de caixa",
                    "Contas a pagar e receber",
                    "Concilia√ß√£o banc√°ria",
                    "Relat√≥rios gerenciais"
                  ]
                },
                {
                  icon: "pie-chart",
                  title: "Dashboards e Relat√≥rios",
                  description: "Visibilidade completa da situa√ß√£o financeira em tempo real",
                  features: [
                    "Dashboards interativos",
                    "Relat√≥rios automatizados",
                    "An√°lises preditivas",
                    "Indicadores de performance"
                  ]
                },
                {
                  icon: "users",
                  title: "Consultoria Estrat√©gica",
                  description: "Suporte especializado para decis√µes estrat√©gicas e crescimento",
                  features: [
                    "Reuni√µes estrat√©gicas",
                    "Planejamento financeiro",
                    "An√°lise de investimentos",
                    "Suporte ao crescimento"
                  ]
                }
              ],
              styles: {
                backgroundColor: "#ffffff",
                textColor: "#333333",
                iconColor: "#0066cc"
              }
            }
          },
          {
            id: "sobre",
            type: "about",
            title: "Sobre a Jota Solu√ß√µes",
            position: 5,
            visible: true,
            editable: true,
            content: {
              headline: "Especialistas em gest√£o financeira empresarial",
              description: "A Jota Solu√ß√µes √© refer√™ncia em BPO Financeiro, com mais de 10 anos de experi√™ncia ajudando empresas a organizar suas finan√ßas e acelerar o crescimento.",
              stats: [
                {
                  number: "450mil+",
                  label: "Empresas analisadas",
                  icon: "building"
                },
                {
                  number: "95%",
                  label: "Taxa de satisfa√ß√£o",
                  icon: "heart"
                },
                {
                  number: "10+",
                  label: "Anos de experi√™ncia",
                  icon: "award"
                }
              ],
              team: {
                visible: true,
                headline: "Nossa equipe especializada",
                members: [
                  {
                    name: "Jo√£o Carlos Silva",
                    role: "CEO & Fundador",
                    photo: "/uploads/images/team-ceo.jpg",
                    bio: "Especialista em gest√£o financeira com mais de 15 anos de experi√™ncia"
                  }
                ]
              }
            }
          },
          {
            id: "depoimentos",
            type: "testimonials",
            title: "Depoimentos",
            position: 6,
            visible: true,
            editable: true,
            content: {
              headline: "O que nossos clientes dizem sobre nossos servi√ßos",
              testimonials: [
                {
                  id: 1,
                  name: "Maria Silva",
                  company: "TechStart Ltda",
                  role: "CEO",
                  photo: "/uploads/images/client-1.jpg",
                  rating: 5,
                  text: "A Jota Solu√ß√µes transformou completamente nossa gest√£o financeira. Agora temos total controle do fluxo de caixa."
                },
                {
                  id: 2,
                  name: "Carlos Santos",
                  company: "Inova√ß√£o Digital",
                  role: "CFO",
                  photo: "/uploads/images/client-2.jpg", 
                  rating: 5,
                  text: "Excelente atendimento e resultados surpreendentes. Recomendo para qualquer empresa que quer crescer."
                }
              ]
            }
          },
          {
            id: "formulario",
            type: "form",
            title: "Formul√°rio de Contato",
            position: 7,
            visible: true,
            editable: true,
            content: {
              headline: "Receba seu diagn√≥stico financeiro gratuito",
              subheadline: "Preencha o formul√°rio abaixo e nossa equipe entrar√° em contato em at√© 24 horas.",
              fields: [
                {
                  name: "nome",
                  label: "Nome completo",
                  type: "text",
                  placeholder: "Digite seu nome completo",
                  required: true,
                  validation: "text"
                },
                {
                  name: "email", 
                  label: "E-mail",
                  type: "email",
                  placeholder: "seu@email.com",
                  required: true,
                  validation: "email"
                },
                {
                  name: "telefone",
                  label: "Telefone",
                  type: "tel", 
                  placeholder: "(11) 99999-9999",
                  required: true,
                  validation: "phone"
                },
                {
                  name: "empresa",
                  label: "Nome da empresa",
                  type: "text",
                  placeholder: "Nome da sua empresa",
                  required: true,
                  validation: "text"
                },
                {
                  name: "faturamento",
                  label: "Faturamento mensal",
                  type: "select",
                  required: true,
                  options: [
                    { value: "ate-10k", label: "At√© R$ 10.000" },
                    { value: "10k-50k", label: "R$ 10.000 - R$ 50.000" },
                    { value: "50k-100k", label: "R$ 50.000 - R$ 100.000" },
                    { value: "100k-500k", label: "R$ 100.000 - R$ 500.000" },
                    { value: "500k-mais", label: "Acima de R$ 500.000" }
                  ]
                },
                {
                  name: "segmento",
                  label: "Segmento da empresa",
                  type: "select",
                  required: false,
                  options: [
                    { value: "tecnologia", label: "Tecnologia" },
                    { value: "comercio", label: "Com√©rcio" },
                    { value: "servicos", label: "Servi√ßos" },
                    { value: "industria", label: "Ind√∫stria" },
                    { value: "consultoria", label: "Consultoria" },
                    { value: "outros", label: "Outros" }
                  ]
                }
              ],
              submitButton: {
                text: "Quero meu diagn√≥stico gratuito",
                style: "primary",
                size: "large"
              },
              successMessage: "Obrigado! Recebemos suas informa√ß√µes e nossa equipe entrar√° em contato em breve.",
              privacy: {
                visible: true,
                text: "Seus dados est√£o seguros conosco e n√£o ser√£o compartilhados com terceiros."
              },
              styles: {
                backgroundColor: "#f8f9fa",
                buttonColor: "#0066cc"
              }
            }
          },
          {
            id: "faq",
            type: "faq",
            title: "Perguntas Frequentes",
            position: 8,
            visible: true,
            editable: true,
            content: {
              headline: "D√∫vidas frequentes sobre nossos servi√ßos",
              questions: [
                {
                  id: 1,
                  question: "Como funciona o diagn√≥stico financeiro gratuito?",
                  answer: "Nosso diagn√≥stico √© uma an√°lise completa da situa√ß√£o financeira atual da sua empresa, identificando pontos de melhoria e oportunidades de crescimento."
                },
                {
                  id: 2,
                  question: "Quanto tempo leva para implementar o BPO Financeiro?",
                  answer: "A implementa√ß√£o varia de acordo com o tamanho e complexidade da empresa, mas geralmente leva entre 2 a 4 semanas para estar totalmente operacional."
                },
                {
                  id: 3,
                  question: "Quais relat√≥rios s√£o fornecidos?",
                  answer: "Fornecemos relat√≥rios de fluxo de caixa, DRE, balan√ßo patrimonial, an√°lises de indicadores financeiros e dashboards personalizados."
                }
              ]
            }
          },
          {
            id: "footer",
            type: "footer",
            title: "Rodap√©",
            position: 9,
            visible: true,
            editable: true,
            content: {
              company: {
                name: "Jota Solu√ß√µes",
                description: "Especialistas em BPO Financeiro e gest√£o empresarial.",
                logo: "/uploads/images/jota-solucoes-logo-white.png"
              },
              contact: {
                email: "contato@jotasolucoes.com.br",
                phone: "(11) 99999-9999",
                address: "S√£o Paulo, SP"
              },
              links: [
                { label: "Pol√≠tica de Privacidade", url: "/privacidade" },
                { label: "Termos de Uso", url: "/termos" }
              ],
              social: [
                { platform: "linkedin", url: "https://linkedin.com/company/jotasolucoes" },
                { platform: "instagram", url: "https://instagram.com/jotasolucoes" }
              ],
              copyright: "¬© 2025 Jota Solu√ß√µes. Todos os direitos reservados."
            }
          }
        ],
        
        // ‚úÖ METADADOS SEO
        seo: {
          metaTitle: "Jota Solu√ß√µes - BPO Financeiro | Diagn√≥stico Gratuito",
          metaDescription: "Transforme a gest√£o financeira da sua empresa com nosso BPO Financeiro especializado. Diagn√≥stico gratuito e resultados comprovados.",
          keywords: ["BPO", "Financeiro", "Consultoria", "Gest√£o", "Diagn√≥stico", "Fluxo de caixa"],
          ogImage: "/uploads/images/og-jota-solucoes.jpg"
        },
        
        // ‚úÖ CONFIGURA√á√ïES DE DESIGN
        settings: {
          theme: "corporate",
          primaryColor: "#0066cc",
          secondaryColor: "#f8f9fa",
          accentColor: "#dc3545",
          fontFamily: "Inter, sans-serif",
          containerWidth: "1200px",
          borderRadius: "8px"
        }
      };
      
      res.json({
        success: true,
        data: jotaSolucoesContent,
        message: "Conte√∫do da Jota Solu√ß√µes carregado com sucesso",
        timestamp: new Date().toISOString()
      });
      
    } else if (slug === "banco-jota") {
      // Dados do Banco Jota
      const bancoJotaContent = {
        id: "banco-jota",
        slug: "banco-jota", 
        title: "Banco Jota",
        description: "Landing page do Banco Jota - Conta digital gratuita",
        status: "published",
        createdAt: "2025-07-10T15:30:00.000Z",
        updatedAt: new Date().toISOString(),
        publishedAt: "2025-07-10T16:00:00.000Z",
        url: "https://bancojota.com.br",
        
        blocks: [
          {
            id: "header",
            type: "header",
            title: "Cabe√ßalho",
            position: 1,
            visible: true,
            editable: true,
            content: {
              logo: {
                src: "/uploads/images/banco-jota-logo.png",
                alt: "Banco Jota",
                width: 150,
                height: 60
              },
              navigation: [
                { label: "Produtos", url: "#produtos", active: true },
                { label: "Cart√µes", url: "#cartoes", active: true },
                { label: "Conta Digital", url: "#conta", active: true },
                { label: "Contato", url: "#contato", active: true }
              ],
              ctaButton: {
                text: "Abrir conta gr√°tis",
                url: "#conta",
                style: "primary",
                visible: true
              }
            }
          },
          {
            id: "hero",
            type: "hero",
            title: "Se√ß√£o Hero", 
            position: 2,
            visible: true,
            editable: true,
            content: {
              headline: "O banco digital que revoluciona suas finan√ßas",
              subheadline: "Conta digital gratuita, cart√£o sem anuidade e investimentos com rentabilidade superior.",
              description: "Junte-se a milhares de clientes que j√° descobriram a liberdade financeira.",
              backgroundImage: {
                src: "/uploads/images/hero-bg-banco.jpg",
                alt: "Background Banco Jota",
                overlay: 0.5
              },
              ctaButton: {
                text: "Abrir conta gr√°tis",
                url: "#conta",
                style: "primary",
                size: "large"
              },
              features: [
                {
                  icon: "credit-card",
                  text: "Cart√£o sem anuidade"
                },
                {
                  icon: "smartphone",
                  text: "App intuitivo e seguro"
                },
                {
                  icon: "trending-up",
                  text: "Investimentos rent√°veis"
                }
              ]
            }
          }
        ],
        
        seo: {
          metaTitle: "Banco Jota - Conta Digital Gratuita",
          metaDescription: "Banco digital com conta gratuita, cart√£o sem anuidade e investimentos rent√°veis. Abra sua conta agora!"
        },
        
        settings: {
          theme: "modern",
          primaryColor: "#6c5ce7",
          secondaryColor: "#a29bfe",
          fontFamily: "Poppins, sans-serif"
        }
      };
      
      res.json({
        success: true,
        data: bancoJotaContent,
        message: "Conte√∫do do Banco Jota carregado com sucesso",
        timestamp: new Date().toISOString()
      });
      
    } else {
      res.status(404).json({
        success: false,
        error: "Landing page n√£o encontrada",
        message: `Conte√∫do para "${slug}" n√£o dispon√≠vel`
      });
    }
    
  } catch (error) {
    console.error("‚ùå Erro ao carregar conte√∫do:", error);
    res.status(500).json({
      success: false,
      error: "Erro interno do servidor"
    });
  }
});

// ‚úÖ ENDPOINT: Atualizar bloco espec√≠fico
app.put("/api/content/landing/:slug/blocks/:blockId", (req, res) => {
  try {
    const { slug, blockId } = req.params;
    const { content } = req.body;
    
    console.log(`üìù Atualizando bloco ${blockId} da landing page ${slug}`);
    
    // Simular atualiza√ß√£o (aqui voc√™ salvaria no banco de dados)
    res.json({
      success: true,
      message: `Bloco ${blockId} atualizado com sucesso`,
      data: {
        blockId,
        content,
        updatedAt: new Date().toISOString()
      }
    });
    
  } catch (error) {
    console.error("‚ùå Erro ao atualizar bloco:", error);
    res.status(500).json({
      success: false,
      error: "Erro ao atualizar bloco"
    });
  }
});

app.get("/api/leads", (req, res) => {
  res.json({
    success: true,
    leads: [],
    total: 0,
    message: "Leads carregados"
  });
});

app.post("/api/leads", (req, res) => {
  res.json({
    success: true,
    message: "Lead recebido com sucesso!"
  });
});

app.get("/api", (req, res) => {
  res.json({
    message: "API Funcional - 212.85.10.205:3000",
    status: "OK",
    endpoints: [
      "GET /api/health",
      "POST /api/auth/login",
      "GET /api/content/landing",
      "GET /api/content/landing/:slug",
      "PUT /api/content/landing/:slug/blocks/:blockId",
      "GET /api/leads"
    ]
  });
});

// ‚úÖ FUN√á√ÉO startServer (NECESS√ÅRIA PARA server/start.js)
const startServer = async () => {
  try {
    app.listen(PORT, "0.0.0.0", () => {
      console.log("üöÄ Servidor FUNCIONAL na porta", PORT);
      console.log("üîê Login: admin/admin123");
      console.log("üìã Landing Pages: Jota Solu√ß√µes + Banco Jota");
      console.log("‚úÖ Sistema operacional!");
    });
  } catch (error) {
    console.error("‚ùå Erro ao iniciar:", error);
    process.exit(1);
  }
};

// ‚úÖ INICIALIZA√á√ÉO DIRETA
if (import.meta.url === `file://${process.argv[1]}`) {
  startServer();
}

// ‚úÖ EXPORTS NECESS√ÅRIOS (PARA server/start.js)
export default app;
export { startServer };

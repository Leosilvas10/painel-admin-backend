import express from "express";
import cors from "cors";
import dotenv from "dotenv";

dotenv.config();

const app = express();
const PORT = process.env.PORT || 3000;

app.use(cors({
  origin: [
    "http://localhost:5173",
    "http://localhost:5174",
    "http://212.85.10.205:3000",
    "https://jotasolucoes.com.br",
    "https://bancojota.com.br"
  ],
  credentials: true,
  methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS", "PATCH"],
  allowedHeaders: ["Content-Type", "Authorization", "X-Requested-With", "Accept", "Origin"]
}));

app.use(express.json());
app.use(express.urlencoded({ extended: true }));

app.get("/api/health", (req, res) => {
  res.json({
    status: "OK",
    message: "Backend FUNCIONAL!",
    server: "212.85.10.205:3000",
    timestamp: new Date().toISOString()
  });
});

app.post("/api/auth/login", (req, res) => {
  const { username, password } = req.body;
  if (username === "admin" && password === "admin123") {
    res.json({
      success: true,
      message: "Login realizado com sucesso",
      token: "token-" + Date.now(),
      user: { id: 1, username: "admin", role: "admin" }
    });
  } else {
    res.status(401).json({ success: false, message: "Credenciais invÃ¡lidas" });
  }
});

app.get("/api/auth/verify", (req, res) => {
  res.json({
    success: true,
    user: { id: 1, username: "admin", role: "admin" }
  });
});

app.post("/api/auth/logout", (req, res) => {
  res.json({ success: true, message: "Logout realizado" });
});

app.get("/api/content/landing", (req, res) => {
  const landingPages = [
    {
      id: "jota-solucoes",
      slug: "jota-solucoes",
      title: "Jota SoluÃ§Ãµes",
      description: "Landing page para BPO Financeiro",
      status: "published",
      createdAt: "2025-07-14T17:40:00.000Z",
      updatedAt: new Date().toISOString(),
      url: "https://jotasolucoes.com.br"
    },
    {
      id: "banco-jota",
      slug: "banco-jota",
      title: "Banco Jota",
      description: "Landing page do Banco Jota",
      status: "published",
      createdAt: "2025-07-10T15:30:00.000Z",
      updatedAt: new Date().toISOString(),
      url: "https://bancojota.com.br"
    }
  ];

  res.json({
    success: true,
    data: landingPages,
    total: landingPages.length,
    message: "Landing pages listadas com sucesso"
  });
});

// âœ… NOVO ENDPOINT ESPECÃFICO: Carregar conteÃºdo detalhado de uma landing page para ediÃ§Ã£o
app.get("/api/content/landing/:slug", (req, res) => {
  try {
    const { slug } = req.params;
    console.log("ğŸ“‹ Carregando conteÃºdo detalhado de:", slug);
    
    // Dados especÃ­ficos da Jota SoluÃ§Ãµes
    if (slug === "jota-solucoes") {
      const jotaSolucoesContent = {
        id: "jota-solucoes",
        slug: "jota-solucoes",
        title: "Jota SoluÃ§Ãµes",
        description: "Landing page para BPO Financeiro - DiagnÃ³stico financeiro gratuito",
        status: "published",
        createdAt: "2025-07-14T17:40:00.000Z",
        updatedAt: new Date().toISOString(),
        publishedAt: "2025-07-14T18:00:00.000Z",
        url: "https://jotasolucoes.com.br",
        
        // âœ… BLOCOS EDITÃVEIS PARA O PAINEL ADMIN
        blocks: [
          {
            id: "header",
            type: "header",
            title: "CabeÃ§alho",
            position: 1,
            visible: true,
            editable: true,
            content: {
              logo: {
                src: "/uploads/images/jota-solucoes-logo.png",
                alt: "Jota SoluÃ§Ãµes",
                width: 150,
                height: 60
              },
              navigation: [
                { label: "InÃ­cio", url: "#inicio", active: true },
                { label: "ServiÃ§os", url: "#servicos", active: true },
                { label: "Sobre", url: "#sobre", active: true },
                { label: "Contato", url: "#contato", active: true }
              ],
              ctaButton: {
                text: "DiagnÃ³stico Gratuito",
                url: "#formulario",
                style: "primary",
                visible: true
              },
              styles: {
                backgroundColor: "#ffffff",
                textColor: "#333333",
                logoPosition: "left"
              }
            }
          },
          {
            id: "hero",
            type: "hero", 
            title: "SeÃ§Ã£o Hero",
            position: 2,
            visible: true,
            editable: true,
            content: {
              headline: "Descubra como transformar a saÃºde financeira da sua empresa!",
              subheadline: "Receba um diagnÃ³stico financeiro gratuito e tenha uma reuniÃ£o estratÃ©gica com o CEO da Jota SoluÃ§Ãµes.",
              description: "Nossa metodologia jÃ¡ ajudou mais de 450 mil empresas a organizar suas finanÃ§as e acelerar o crescimento.",
              backgroundImage: {
                src: "/uploads/images/hero-bg-jota.jpg",
                alt: "Background Jota SoluÃ§Ãµes",
                overlay: 0.6
              },
              ctaButton: {
                text: "Quero meu diagnÃ³stico gratuito",
                url: "#formulario",
                style: "primary",
                size: "large"
              },
              secondaryButton: {
                text: "Conhecer serviÃ§os",
                url: "#servicos",
                style: "outline",
                visible: true
              },
              features: [
                {
                  icon: "check-circle",
                  text: "DiagnÃ³stico financeiro completo"
                },
                {
                  icon: "check-circle", 
                  text: "ReuniÃ£o estratÃ©gica personalizada"
                },
                {
                  icon: "check-circle",
                  text: "AnÃ¡lise de 450 mil empresas"
                },
                {
                  icon: "check-circle",
                  text: "Resultados comprovados"
                }
              ],
              styles: {
                textAlign: "center",
                headlineColor: "#ffffff",
                subheadlineColor: "#f8f9fa",
                buttonColor: "#0066cc"
              }
            }
          },
          {
            id: "dores",
            type: "pain-points",
            title: "Dores e Problemas",
            position: 3,
            visible: true,
            editable: true,
            content: {
              headline: "Sua empresa enfrenta esses desafios financeiros?",
              subheadline: "Sabemos que gerenciar as finanÃ§as de uma empresa pode ser complexo e desafiador.",
              problems: [
                {
                  icon: "alert-triangle",
                  title: "Fluxo de caixa descontrolado",
                  description: "Dificuldade para acompanhar entradas e saÃ­das em tempo real"
                },
                {
                  icon: "eye-off",
                  title: "Falta de visibilidade financeira",
                  description: "NÃ£o saber exatamente a situaÃ§Ã£o financeira da empresa"
                },
                {
                  icon: "clock",
                  title: "Processos manuais demorados",
                  description: "Perda de tempo com planilhas e controles manuais"
                },
                {
                  icon: "bar-chart",
                  title: "DecisÃµes sem dados precisos",
                  description: "Tomar decisÃµes importantes sem informaÃ§Ãµes confiÃ¡veis"
                }
              ],
              styles: {
                backgroundColor: "#f8f9fa",
                textColor: "#333333",
                iconColor: "#dc3545"
              }
            }
          },
          {
            id: "solucoes",
            type: "solutions",
            title: "Nossas SoluÃ§Ãµes",
            position: 4,
            visible: true,
            editable: true,
            content: {
              headline: "Como a Jota SoluÃ§Ãµes resolve seus problemas financeiros",
              subheadline: "Oferecemos soluÃ§Ãµes completas para transformar a gestÃ£o financeira da sua empresa.",
              solutions: [
                {
                  icon: "trending-up",
                  title: "BPO Financeiro Completo",
                  description: "TerceirizaÃ§Ã£o completa do setor financeiro com processos otimizados",
                  features: [
                    "Controle de fluxo de caixa",
                    "Contas a pagar e receber",
                    "ConciliaÃ§Ã£o bancÃ¡ria",
                    "RelatÃ³rios gerenciais"
                  ]
                },
                {
                  icon: "pie-chart",
                  title: "Dashboards e RelatÃ³rios",
                  description: "Visibilidade completa da situaÃ§Ã£o financeira em tempo real",
                  features: [
                    "Dashboards interativos",
                    "RelatÃ³rios automatizados",
                    "AnÃ¡lises preditivas",
                    "Indicadores de performance"
                  ]
                },
                {
                  icon: "users",
                  title: "Consultoria EstratÃ©gica",
                  description: "Suporte especializado para decisÃµes estratÃ©gicas e crescimento",
                  features: [
                    "ReuniÃµes estratÃ©gicas",
                    "Planejamento financeiro",
                    "AnÃ¡lise de investimentos",
                    "Suporte ao crescimento"
                  ]
                }
              ],
              styles: {
                backgroundColor: "#ffffff",
                textColor: "#333333",
                iconColor: "#0066cc"
              }
            }
          },
          {
            id: "sobre",
            type: "about",
            title: "Sobre a Jota SoluÃ§Ãµes",
            position: 5,
            visible: true,
            editable: true,
            content: {
              headline: "Especialistas em gestÃ£o financeira empresarial",
              description: "A Jota SoluÃ§Ãµes Ã© referÃªncia em BPO Financeiro, com mais de 10 anos de experiÃªncia ajudando empresas a organizar suas finanÃ§as e acelerar o crescimento.",
              stats: [
                {
                  number: "450mil+",
                  label: "Empresas analisadas",
                  icon: "building"
                },
                {
                  number: "95%",
                  label: "Taxa de satisfaÃ§Ã£o",
                  icon: "heart"
                },
                {
                  number: "10+",
                  label: "Anos de experiÃªncia",
                  icon: "award"
                }
              ],
              team: {
                visible: true,
                headline: "Nossa equipe especializada",
                members: [
                  {
                    name: "JoÃ£o Carlos Silva",
                    role: "CEO & Fundador",
                    photo: "/uploads/images/team-ceo.jpg",
                    bio: "Especialista em gestÃ£o financeira com mais de 15 anos de experiÃªncia"
                  }
                ]
              }
            }
          },
          {
            id: "depoimentos",
            type: "testimonials",
            title: "Depoimentos",
            position: 6,
            visible: true,
            editable: true,
            content: {
              headline: "O que nossos clientes dizem sobre nossos serviÃ§os",
              testimonials: [
                {
                  id: 1,
                  name: "Maria Silva",
                  company: "TechStart Ltda",
                  role: "CEO",
                  photo: "/uploads/images/client-1.jpg",
                  rating: 5,
                  text: "A Jota SoluÃ§Ãµes transformou completamente nossa gestÃ£o financeira. Agora temos total controle do fluxo de caixa."
                },
                {
                  id: 2,
                  name: "Carlos Santos",
                  company: "InovaÃ§Ã£o Digital",
                  role: "CFO",
                  photo: "/uploads/images/client-2.jpg", 
                  rating: 5,
                  text: "Excelente atendimento e resultados surpreendentes. Recomendo para qualquer empresa que quer crescer."
                }
              ]
            }
          },
          {
            id: "formulario",
            type: "form",
            title: "FormulÃ¡rio de Contato",
            position: 7,
            visible: true,
            editable: true,
            content: {
              headline: "Receba seu diagnÃ³stico financeiro gratuito",
              subheadline: "Preencha o formulÃ¡rio abaixo e nossa equipe entrarÃ¡ em contato em atÃ© 24 horas.",
              fields: [
                {
                  name: "nome",
                  label: "Nome completo",
                  type: "text",
                  placeholder: "Digite seu nome completo",
                  required: true,
                  validation: "text"
                },
                {
                  name: "email", 
                  label: "E-mail",
                  type: "email",
                  placeholder: "seu@email.com",
                  required: true,
                  validation: "email"
                },
                {
                  name: "telefone",
                  label: "Telefone",
                  type: "tel", 
                  placeholder: "(11) 99999-9999",
                  required: true,
                  validation: "phone"
                },
                {
                  name: "empresa",
                  label: "Nome da empresa",
                  type: "text",
                  placeholder: "Nome da sua empresa",
                  required: true,
                  validation: "text"
                },
                {
                  name: "faturamento",
                  label: "Faturamento mensal",
                  type: "select",
                  required: true,
                  options: [
                    { value: "ate-10k", label: "AtÃ© R$ 10.000" },
                    { value: "10k-50k", label: "R$ 10.000 - R$ 50.000" },
                    { value: "50k-100k", label: "R$ 50.000 - R$ 100.000" },
                    { value: "100k-500k", label: "R$ 100.000 - R$ 500.000" },
                    { value: "500k-mais", label: "Acima de R$ 500.000" }
                  ]
                },
                {
                  name: "segmento",
                  label: "Segmento da empresa",
                  type: "select",
                  required: false,
                  options: [
                    { value: "tecnologia", label: "Tecnologia" },
                    { value: "comercio", label: "ComÃ©rcio" },
                    { value: "servicos", label: "ServiÃ§os" },
                    { value: "industria", label: "IndÃºstria" },
                    { value: "consultoria", label: "Consultoria" },
                    { value: "outros", label: "Outros" }
                  ]
                }
              ],
              submitButton: {
                text: "Quero meu diagnÃ³stico gratuito",
                style: "primary",
                size: "large"
              },
              successMessage: "Obrigado! Recebemos suas informaÃ§Ãµes e nossa equipe entrarÃ¡ em contato em breve.",
              privacy: {
                visible: true,
                text: "Seus dados estÃ£o seguros conosco e nÃ£o serÃ£o compartilhados com terceiros."
              },
              styles: {
                backgroundColor: "#f8f9fa",
                buttonColor: "#0066cc"
              }
            }
          },
          {
            id: "faq",
            type: "faq",
            title: "Perguntas Frequentes",
            position: 8,
            visible: true,
            editable: true,
            content: {
              headline: "DÃºvidas frequentes sobre nossos serviÃ§os",
              questions: [
                {
                  id: 1,
                  question: "Como funciona o diagnÃ³stico financeiro gratuito?",
                  answer: "Nosso diagnÃ³stico Ã© uma anÃ¡lise completa da situaÃ§Ã£o financeira atual da sua empresa, identificando pontos de melhoria e oportunidades de crescimento."
                },
                {
                  id: 2,
                  question: "Quanto tempo leva para implementar o BPO Financeiro?",
                  answer: "A implementaÃ§Ã£o varia de acordo com o tamanho e complexidade da empresa, mas geralmente leva entre 2 a 4 semanas para estar totalmente operacional."
                },
                {
                  id: 3,
                  question: "Quais relatÃ³rios sÃ£o fornecidos?",
                  answer: "Fornecemos relatÃ³rios de fluxo de caixa, DRE, balanÃ§o patrimonial, anÃ¡lises de indicadores financeiros e dashboards personalizados."
                }
              ]
            }
          },
          {
            id: "footer",
            type: "footer",
            title: "RodapÃ©",
            position: 9,
            visible: true,
            editable: true,
            content: {
              company: {
                name: "Jota SoluÃ§Ãµes",
                description: "Especialistas em BPO Financeiro e gestÃ£o empresarial.",
                logo: "/uploads/images/jota-solucoes-logo-white.png"
              },
              contact: {
                email: "contato@jotasolucoes.com.br",
                phone: "(11) 99999-9999",
                address: "SÃ£o Paulo, SP"
              },
              links: [
                { label: "PolÃ­tica de Privacidade", url: "/privacidade" },
                { label: "Termos de Uso", url: "/termos" }
              ],
              social: [
                { platform: "linkedin", url: "https://linkedin.com/company/jotasolucoes" },
                { platform: "instagram", url: "https://instagram.com/jotasolucoes" }
              ],
              copyright: "Â© 2025 Jota SoluÃ§Ãµes. Todos os direitos reservados."
            }
          }
        ],
        
        // âœ… METADADOS SEO
        seo: {
          metaTitle: "Jota SoluÃ§Ãµes - BPO Financeiro | DiagnÃ³stico Gratuito",
          metaDescription: "Transforme a gestÃ£o financeira da sua empresa com nosso BPO Financeiro especializado. DiagnÃ³stico gratuito e resultados comprovados.",
          keywords: ["BPO", "Financeiro", "Consultoria", "GestÃ£o", "DiagnÃ³stico", "Fluxo de caixa"],
          ogImage: "/uploads/images/og-jota-solucoes.jpg"
        },
        
        // âœ… CONFIGURAÃ‡Ã•ES DE DESIGN
        settings: {
          theme: "corporate",
          primaryColor: "#0066cc",
          secondaryColor: "#f8f9fa",
          accentColor: "#dc3545",
          fontFamily: "Inter, sans-serif",
          containerWidth: "1200px",
          borderRadius: "8px"
        }
      };
      
      res.json({
        success: true,
        data: jotaSolucoesContent,
        message: "ConteÃºdo da Jota SoluÃ§Ãµes carregado com sucesso",
        timestamp: new Date().toISOString()
      });
      
    } else if (slug === "banco-jota") {
      // Dados do Banco Jota
      const bancoJotaContent = {
        id: "banco-jota",
        slug: "banco-jota", 
        title: "Banco Jota",
        description: "Landing page do Banco Jota - Conta digital gratuita",
        status: "published",
        createdAt: "2025-07-10T15:30:00.000Z",
        updatedAt: new Date().toISOString(),
        publishedAt: "2025-07-10T16:00:00.000Z",
        url: "https://bancojota.com.br",
        
        blocks: [
          {
            id: "header",
            type: "header",
            title: "CabeÃ§alho",
            position: 1,
            visible: true,
            editable: true,
            content: {
              logo: {
                src: "/uploads/images/banco-jota-logo.png",
                alt: "Banco Jota",
                width: 150,
                height: 60
              },
              navigation: [
                { label: "Produtos", url: "#produtos", active: true },
                { label: "CartÃµes", url: "#cartoes", active: true },
                { label: "Conta Digital", url: "#conta", active: true },
                { label: "Contato", url: "#contato", active: true }
              ],
              ctaButton: {
                text: "Abrir conta grÃ¡tis",
                url: "#conta",
                style: "primary",
                visible: true
              }
            }
          },
          {
            id: "hero",
            type: "hero",
            title: "SeÃ§Ã£o Hero", 
            position: 2,
            visible: true,
            editable: true,
            content: {
              headline: "O banco digital que revoluciona suas finanÃ§as",
              subheadline: "Conta digital gratuita, cartÃ£o sem anuidade e investimentos com rentabilidade superior.",
              description: "Junte-se a milhares de clientes que jÃ¡ descobriram a liberdade financeira.",
              backgroundImage: {
                src: "/uploads/images/hero-bg-banco.jpg",
                alt: "Background Banco Jota",
                overlay: 0.5
              },
              ctaButton: {
                text: "Abrir conta grÃ¡tis",
                url: "#conta",
                style: "primary",
                size: "large"
              },
              features: [
                {
                  icon: "credit-card",
                  text: "CartÃ£o sem anuidade"
                },
                {
                  icon: "smartphone",
                  text: "App intuitivo e seguro"
                },
                {
                  icon: "trending-up",
                  text: "Investimentos rentÃ¡veis"
                }
              ]
            }
          }
        ],
        
        seo: {
          metaTitle: "Banco Jota - Conta Digital Gratuita",
          metaDescription: "Banco digital com conta gratuita, cartÃ£o sem anuidade e investimentos rentÃ¡veis. Abra sua conta agora!"
        },
        
        settings: {
          theme: "modern",
          primaryColor: "#6c5ce7",
          secondaryColor: "#a29bfe",
          fontFamily: "Poppins, sans-serif"
        }
      };
      
      res.json({
        success: true,
        data: bancoJotaContent,
        message: "ConteÃºdo do Banco Jota carregado com sucesso",
        timestamp: new Date().toISOString()
      });
      
    } else {
      res.status(404).json({
        success: false,
        error: "Landing page nÃ£o encontrada",
        message: `ConteÃºdo para "${slug}" nÃ£o disponÃ­vel`
      });
    }
    
  } catch (error) {
    console.error("âŒ Erro ao carregar conteÃºdo:", error);
    res.status(500).json({
      success: false,
      error: "Erro interno do servidor"
    });
  }
});

// âœ… ENDPOINT: Atualizar bloco especÃ­fico
app.put("/api/content/landing/:slug/blocks/:blockId", (req, res) => {
  try {
    const { slug, blockId } = req.params;
    const { content } = req.body;
    
    console.log(`ğŸ“ Atualizando bloco ${blockId} da landing page ${slug}`);
    
    // Simular atualizaÃ§Ã£o (aqui vocÃª salvaria no banco de dados)
    res.json({
      success: true,
      message: `Bloco ${blockId} atualizado com sucesso`,
      data: {
        blockId,
        content,
        updatedAt: new Date().toISOString()
      }
    });
    
  } catch (error) {
    console.error("âŒ Erro ao atualizar bloco:", error);
    res.status(500).json({
      success: false,
      error: "Erro ao atualizar bloco"
    });
  }
});

app.get("/api/leads", (req, res) => {
  res.json({
    success: true,
    leads: [],
    total: 0,
    message: "Leads carregados"
  });
});

app.post("/api/leads", (req, res) => {
  res.json({
    success: true,
    message: "Lead recebido com sucesso!"
  });
});

app.get("/api", (req, res) => {
  res.json({
    message: "API Funcional - 212.85.10.205:3000",
    status: "OK",
    endpoints: [
      "GET /api/health",
      "POST /api/auth/login",
      "GET /api/content/landing",
      "GET /api/content/landing/:slug",
      "PUT /api/content/landing/:slug/blocks/:blockId",
      "GET /api/leads"
    ]
  });
});

// âœ… FUNÃ‡ÃƒO startServer (NECESSÃRIA PARA server/start.js)
const startServer = async () => {
  try {
    app.listen(PORT, "0.0.0.0", () => {
      console.log("ğŸš€ Servidor FUNCIONAL na porta", PORT);
      console.log("ğŸ” Login: admin/admin123");
      console.log("ğŸ“‹ Landing Pages: Jota SoluÃ§Ãµes + Banco Jota");
      console.log("âœ… Sistema operacional!");
    });
  } catch (error) {
    console.error("âŒ Erro ao iniciar:", error);
    process.exit(1);
  }
};

// âœ… INICIALIZAÃ‡ÃƒO DIRETA
if (import.meta.url === `file://${process.argv[1]}`) {
  startServer();
}

// âœ… EXPORTS NECESSÃRIOS (PARA server/start.js)
export default app;
export { startServer };
